# AstrBot Plugin VITS Pro

> 实验性增强版 · 当前版本：**v1.7.0**  
> 新增：TTS 黑 / 白名单，可更灵活控制不同会话的语音合成状态。

<p align="left">
  <img src="https://img.shields.io/badge/version-v1.7.0-blue.svg" />
  <img src="https://img.shields.io/badge/status-experimental-orange.svg" />
  <img src="https://img.shields.io/badge/feature-TTS%20增强-success.svg" />
  <img src="https://img.shields.io/badge/API-硅基流动-lightgrey.svg" />
</p>

---

## 目录
- [情绪调用说明](#情绪调用说明)
- [重要提示](#重要提示)
- [功能概览](#功能概览)
- [配置说明](#配置说明)
- [音色与模型规则](#音色与模型规则)
- [常见问题 FAQ](#常见问题-faq)
- [支持的音色](#支持的音色)
- [命令使用参考](#命令使用参考)
- [高级功能](#高级功能)
- [使用说明](#使用说明)
- [更新日志](#更新日志)

---

## 情绪调用说明

默认不启用“情绪模式”。如果你需要让模型返回带情绪的语音，请在角色人设中加入以下硬性格式约束（不必担心前缀，插件会自动剔除）：

在你回复开始前，你必须表明你这次回复时的情绪，包括以下几种情绪：快乐（happy）、兴奋（excited）、悲伤（sad）、愤怒（angry），不存在的情绪禁止新创。  
你回复的具体格式为：  
`happy emotion<|endofprompt|>` / `excited emotion<|endofprompt|>` / `sad emotion<|endofprompt|>` / `angry emotion<|endofprompt|>` + 正文内容

示例：
```
happy emotion<|endofprompt|>这个问题我很清楚！
excited emotion<|endofprompt|>早安，今天也要元气满满哦！
sad emotion<|endofprompt|>对不起，这样做是不对的，我很伤心。
angry emotion<|endofprompt|>哇！你这个变态真是无药可救了！
```
约束：
- 每次回复只允许一种情绪
- 不要过度使用情绪
- 情绪需与上下文语境一致

---

## 重要提示

### 1. 不要开启原本内置的 TTS  
![不要开原来的TTS](img.png)

### 2. 带 “@” 和“回复” 的消息会吞语音  
请关闭相关自动行为  
![@和回复吞语音说明](img_2.png)

---

## 功能概览
- 基于硅基流动（SiliconFlow）API 的文本转语音
- 支持系统预置音色 + 自定义上传音色
- 支持：TTS 总开关、音色切换、播放速度、增益、概率控制
- 支持关键词过滤与智能跳过内容
- 支持 TTS 黑 / 白名单（v1.7.0 新增）
- 支持最大字符限制与参考模式（情绪接口调用）
- 支持状态持久化（重启后保留 TTS 开关状态）

---

## 配置说明

在插件面板中需要填写：
- URL（末尾必须加 `/v1`） → 示例：`https://api.siliconflow.cn/v1`
- API Key
- 模型名字（例如：`FunAudioLLM/CosyVoice2-0.5B`）
- 音色（格式见下文）
- 全局 TTS 状态保存（开启后重启保留）

界面示意：  
![配置面板](img_1.png)

---

## 音色与模型规则

音色（voice）前必须带模型名，并用英文冒号 `:` 分隔。  
例如使用 `FunAudioLLM/CosyVoice2-0.5B` 模型的 `alex` 音色：

- name（模型名）填写：  
  `FunAudioLLM/CosyVoice2-0.5B`
- voice（音色）填写：  
  `FunAudioLLM/CosyVoice2-0.5B:alex`

---

## 常见问题 FAQ

| 问题 | 回答 |
|------|------|
| 为什么有一小部分语音没有读出来？ | 硅基流动可能存在内容审核，敏感或存疑内容会被裁剪。 |
| 调试模式时看到 `emotion<endofprompt>`，前缀的情绪词不见了？ | 可能被 `astrbot_plugin_meme_manager` 过滤，不影响功能，故暂不修改。 |
| 情绪不生效？ | 确认已在角色提示词中强制指定上述情绪格式。 |
| 音色切换没反应？ | 确认 voice 参数格式正确：`模型名:音色名`。 |
| 为什么命令有效但不播音？ | 检查是否处于黑 / 白名单限制范围、或被过滤规则跳过。 |

---

## 支持的音色

### 系统预置音色

| 分类 | 说明 | 名称 |
|------|------|------|
| 男声 | 沉稳男声 | alex |
| 男声 | 低沉男声 | benjamin |
| 男声 | 磁性男声 | charles |
| 男声 | 欢快男声 | david |
| 女声 | 沉稳女声 | anna |
| 女声 | 激情女声 | bella |
| 女声 | 温柔女声 | claire |
| 女声 | 欢快女声 | diana |

### 自定义音色
支持在硅基流动平台上传的自定义音色（按平台规则绑定模型）。

在线音色上传控制台：  
🔗 https://voice.gbkgov.cn

---

## 命令使用参考

### 基础控制
| 命令 | 说明 |
|------|------|
| `/vits` | 启用 / 禁用插件（状态持久化） |
| `/vitsinfo` | 查看当前配置与状态 |

### 音色相关
| 命令 | 说明 | 示例 |
|------|------|------|
| `/voices` | 列出所有可用音色 | `/voices` |
| `/voice <音色名>` | 切换音色 | `/voice alex` |

### 概率控制
| 命令 | 说明 | 示例 |
|------|------|------|
| `/vits%` | 查看当前转换概率 | `/vits%` |
| `/vits% <数字>` | 设置 0–100 概率 | `/vits% 50` |

### 音频参数
| 命令 | 说明 | 示例 |
|------|------|------|
| `/speed` | 查看当前播放速度 | `/speed` |
| `/speed <数值>` | 设置速度（0.25–4.0） | `/speed 1.25` |
| `/gain` | 查看当前增益 | `/gain` |
| `/gain <数值>` | 设置增益（-10~10 dB） | `/gain 3` |

---

## 高级功能

### 智能过滤（自动跳过）：
- 包含网址（http / https）
- 图片消息
- 特定关键词（默认：astrbot、语音、音色、TTS、转换 等；可自定义）

### 黑 / 白名单控制（v1.7.0）
- 自定义哪些会话启用 / 禁用 TTS
- 精细化管理多会话场景

### 状态持久化
- 全局 TTS 开关记录在配置中
- 重启框架 / 重载插件保留状态

### 音频参数摘要
| 参数 | 范围 | 默认 | 说明 |
|------|------|------|------|
| 播放速度 | 0.25–4.0 | 1.0 | 语速倍数 |
| 音频增益 | -10~10 dB | 0 | 调整音量 |
| 转换概率 | 0–100% | 100 | 随机转语音概率 |

---

## 使用说明

1. 初次使用：填写 API / 模型 / 音色 → 输入 `/vits` 启用
2. 切换音色：`/voice alex`（可选）
3. 调整语速：`/speed 1.2`（可选）
4. 控制音量：`/gain 2`（可选）
5. 设置概率：`/vits% 60`（可选）
6. 查看状态：`/vitsinfo`（可选）
7. 加情绪：在角色提示词中加入格式规范（见前文）

---

## 更新日志

| 版本 / 日期 | 说明 |
|-------------|------|
| 2024.02.09 | 解决图片发送冲突，修复路径错误 bug |
| v1.3.0 | 新增音色快速切换、概率控制、关键词过滤 |
| v1.4.0 | 新增播放速度（speed）与音频增益（gain）控制 |
| v1.5.0 | 新增 TTS 最大字符限制；适配 AstrBot 稳定版 v3.5.27 |
| v1.6.0 | 新增参考模式，支持调用模型本身情绪接口 |
| v1.7.0 | 新增 TTS 黑 / 白名单控制 |

---


祝您使用愉快，如有bug或建议，欢迎通过QQ：1436198709 联系讨论。 🎧
